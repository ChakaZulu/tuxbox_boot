#include <stdio.h>
#include <malloc.h>
#include "i2c.h"

static unsigned char SAA7126_INIT[] = {

  0x00, 0x00, 0x00, 0x00, 0x00, 0x4e, 0x80, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x0f, 0xf7, 0xef, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x3f, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x21, 0x1d, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00,
  0x3f, 0x00, 0x00, 0x0f, 0x00, 0x00, 0xff, 0x00,
  0x1a, 0x1a, 
//  0x03, // normal mode
  0x80, // colorbar mode
  0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x68, 0x7d, 0xaf, 0x33, 0x35, 0x35,
  0x00, 0x06, 0x2f, 0xcb, 0x8a, 0x09, 0x2a, 0x00,
  0x00, 0x00, 0x00, 0x52, 0x28, 0x01, 0x20, 0x31,
  0x7d, 0xbc, 0x60, 0x41, 0x05, 0x00, 0x06, 0x16,
  0x06, 0x16, 0x16, 0x36, 0x60, 0x00, 0x00, 0x00
  
};

void i2c_bus_init(void)
{
  i2c_init();
  i2c_setspeed(50000);
}

void saa7126_init(void)
{
  i2c_send(0x88, 0x00, 0x01, 0x40, SAA7126_INIT);
  i2c_send(0x88, 0x40, 0x01, 0x40, SAA7126_INIT + 0x40);
}

void avs_init(char mId)
{
  switch(mId) {
    case 1:
      i2c_send(0x90, 0, 0, 5, "\x0d\x29\xc9\xa9\x00");
      i2c_send(0x90, 0, 0, 5, "\x0f\x29\xc9\xa9\x80");
      i2c_send(0x90, 0, 0, 5, "\x0f\x2f\xcf\xaf\x80");
      i2c_send(0x90, 0, 0, 5, "\x0f\x29\xc9\xa9\x80");
      i2c_send(0x90, 0, 0, 5, "\x0d\x29\xc9\xa9\x00");
    break;
    case 2:
      i2c_send(0x94, 0, 0, 8, "\x00\x0a\x19\x99\xb5\x08\x34\x88");
    break;	
    case 3:
      i2c_send(0x90, 0, 0, 7, "\x00\x00\x00\x00\x00\x3F\x00");
    break;	
  }    
}

void fb_init(void)
{

  unsigned char mID = *(char*)(0x1001ffe0);

  i2c_bus_init();
  saa7126_init();

  switch (mID) {
    case 1:
      // NOKIA (GTX + CXA2092)
      //gtxcore_init();
      //decodestillmpg(gtxmem, iframe_logo, XRES, YRES);
      //gtxvideo_init();
    break;
    case 2:
      // Philips (eNX + STV6411A)
    case 3:
      // SAGEM (eNX + CXA2126)
      //enxcore_init();
      //decodestillmpg(enx_get_mem_addr(), iframe_logo, XRES, YRES);
      //enxvideo_init();
    break;
  }
  
  avs_init(mID);
}
